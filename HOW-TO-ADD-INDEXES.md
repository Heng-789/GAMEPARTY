# ЁЯФе р╕зр╕┤р╕Шр╕╡р╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕б Indexes р╕ер╕Зр╣Гр╕Щ Database Rules

## ЁЯУЛ р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕б Indexes

### р╕зр╕┤р╕Шр╕╡р╕Чр╕╡р╣И 1: р╣Ар╕Юр╕┤р╣Ир╕б Indexes р╣Бр╕вр╕Бр╕Ир╕▓р╕Б Rules (р╣Бр╕Щр╕░р╕Щр╕│)

р╕Цр╣Йр╕▓ rules р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╣Ар╕Ыр╣Зр╕Щр╣Бр╕Ър╕Ър╕Щр╕╡р╣Й:

```json
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
```

р╣Гр╕лр╣Йр╣Ар╕Юр╕┤р╣Ир╕б indexes р╣Ар╕Вр╣Йр╕▓р╣Др╕Ыр╣Бр╕Ър╕Ър╕Щр╕╡р╣Й:

```json
{
  "rules": {
    // тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б Indexes р╕Бр╣Ир╕нр╕Щ rules р╕нр╕╖р╣Ир╕Щр╣Ж
    "games": {
      "$gameId": {
        "bingo": {
          "cards": {
            ".indexOn": ["userId"]
          }
        }
      }
    },
    
    "chat": {
      "$gameId": {
        ".indexOn": ["timestamp"]
      }
    },
    
    "krathongs": {
      "$gameId": {
        "recent": {
          ".indexOn": ["timestamp"]
        }
      }
    },
    
    // Rules р╣Ар╕Фр╕┤р╕бр╕Вр╕нр╕Зр╕Др╕╕р╕У
    ".read": true,
    ".write": true
  }
}
```

---

### р╕зр╕┤р╕Шр╕╡р╕Чр╕╡р╣И 2: р╕гр╕зр╕б Indexes р╣Ар╕Вр╣Йр╕▓р╕Бр╕▒р╕Ъ Rules р╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕вр╕╣р╣И

р╕Цр╣Йр╕▓ rules р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕бр╕╡ structure р╣Бр╕ер╣Йр╕з р╣Ар╕Кр╣Ир╕Щ:

```json
{
  "rules": {
    "games": {
      "$gameId": {
        ".read": true,
        ".write": true
      }
    },
    "chat": {
      "$gameId": {
        ".read": true,
        ".write": true
      }
    }
  }
}
```

р╣Гр╕лр╣Йр╣Ар╕Юр╕┤р╣Ир╕б `.indexOn` р╣Ар╕Вр╣Йр╕▓р╣Др╕Ыр╣Гр╕Щ structure р╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕вр╕╣р╣И:

```json
{
  "rules": {
    "games": {
      "$gameId": {
        ".read": true,
        ".write": true,
        
        // тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б Index р╕кр╕│р╕лр╕гр╕▒р╕Ъ BingoGame Cards
        "bingo": {
          "cards": {
            ".indexOn": ["userId"]
          }
        }
      }
    },
    
    "chat": {
      "$gameId": {
        ".read": true,
        ".write": true,
        // тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б Index р╕кр╕│р╕лр╕гр╕▒р╕Ъ LiveChat
        ".indexOn": ["timestamp"]
      }
    },
    
    // тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б Index р╕кр╕│р╕лр╕гр╕▒р╕Ъ LoyKrathongGame (р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡ structure)
    "krathongs": {
      "$gameId": {
        "recent": {
          ".indexOn": ["timestamp"]
        }
      }
    }
  }
}
```

---

## тЪая╕П р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕р╕кр╕│р╕Др╕▒р╕Н

### 1. `.indexOn` р╣Др╕бр╣Ир╣Гр╕Кр╣И Security Rule
- `.indexOn` р╣Ар╕Ыр╣Зр╕Щр╣Бр╕Др╣Ир╕Бр╕▓р╕гр╕Ър╕нр╕Б Firebase р╕зр╣Ир╕▓ field р╣Др╕лр╕Щр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕З index
- р╣Др╕бр╣Ир╕бр╕╡р╕Ьр╕ер╕Хр╣Ир╕нр╕Бр╕▓р╕гр╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╣Гр╕лр╣Йр╕нр╣Ир╕▓р╕Щ/р╣Ар╕Вр╕╡р╕вр╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е

### 2. р╕кр╕▓р╕бр╕▓р╕гр╕Цр╕бр╕╡р╕лр╕ер╕▓р╕в Indexes р╣Гр╕Щ path р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
```json
{
  "games": {
    "$gameId": {
      "bingo": {
        "cards": {
          ".indexOn": ["userId", "createdAt", "status"]  // тЬЕ р╕лр╕ер╕▓р╕в indexes
        }
      }
    }
  }
}
```

### 3. Indexes р╕Хр╣Йр╕нр╕Зр╕нр╕вр╕╣р╣Ир╣Гр╕Щ path р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
```json
// тЬЕ р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З - Index р╕нр╕вр╕╣р╣Ир╣Гр╕Щ path р╕Чр╕╡р╣Ир╕Хр╕гр╕Зр╕Бр╕▒р╕Ъ query
"games": {
  "$gameId": {
    "bingo": {
      "cards": {
        ".indexOn": ["userId"]  // тЬЕ р╕Хр╕гр╕Зр╕Бр╕▒р╕Ъ games/{gameId}/bingo/cards
      }
    }
  }
}

// тЭМ р╕Ьр╕┤р╕Ф - Index р╣Др╕бр╣Ир╕нр╕вр╕╣р╣Ир╣Гр╕Щ path р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
"games": {
  ".indexOn": ["userId"]  // тЭМ р╕Ьр╕┤р╕Ф! р╕Др╕зр╕гр╕нр╕вр╕╣р╣Ир╣Гр╕Щ bingo/cards
}
```

---

## ЁЯФН р╕зр╕┤р╕Шр╕╡р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ Index р╕Чр╕│р╕Зр╕▓р╕Щр╕лр╕гр╕╖р╕нр╣Др╕бр╣И

### 1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Гр╕Щ Firebase Console

1. р╣Др╕Ыр╕Чр╕╡р╣И **Realtime Database** > **Data**
2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ warning р╕лр╕гр╕╖р╕н error р╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Бр╕▒р╕Ъ index р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
3. р╕Цр╣Йр╕▓р╕бр╕╡ warning р╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Бр╕▒р╕Ъ "index" р╕Ир╕░р╣Бр╕кр╕Фр╕Зр╕ер╕┤р╕Зр╕Бр╣Мр╣Гр╕лр╣Йр╕кр╕гр╣Йр╕▓р╕З index

### 2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Гр╕Щ Browser Console

1. р╣Ар╕Ыр╕┤р╕Ф Developer Tools (F12)
2. р╣Др╕Ыр╕Чр╕╡р╣И Console
3. р╕Фр╕╣р╕зр╣Ир╕▓р╕бр╕╡ warning р╣Бр╕Ър╕Ър╕Щр╕╡р╣Йр╣Др╕лр╕б:

```
тЪая╕П Bingo cards query requires index. Using fallback (listening to all cards).
Please create index in Firebase Console: [error details]
```

**р╕Цр╣Йр╕▓р╣Ар╕лр╣Зр╕Щ warning:**
- Index р╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕кр╕гр╣Йр╕▓р╕З р╕лр╕гр╕╖р╕н
- Index р╕нр╕вр╕╣р╣Ир╣Гр╕Щ path р╕Чр╕╡р╣Ир╕Ьр╕┤р╕Ф р╕лр╕гр╕╖р╕н
- Rules р╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З

**р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╣Ар╕лр╣Зр╕Щ warning:**
- Index р╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕ер╣Йр╕з

### 3. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Performance

- **р╕Бр╣Ир╕нр╕Щр╕кр╕гр╣Йр╕▓р╕З index:** Query р╕нр╕▓р╕Ир╕Кр╣Йр╕▓р╕лр╕гр╕╖р╕нр╣Гр╕Кр╣Й fallback (listen р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф)
- **р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╕кр╕гр╣Йр╕▓р╕З index:** Query р╕Др╕зр╕гр╣Ар╕гр╣Зр╕зр╕Вр╕╢р╣Йр╕Щр╣Бр╕ер╕░р╣Гр╕Кр╣Йр╣Ар╕Йр╕Юр╕▓р╕░р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ

---

## ЁЯУЭ Checklist

- [ ] р╕нр╣Ир╕▓р╕Щ rules р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щр╕Ир╕▓р╕Б Firebase Console
- [ ] р╣Ар╕Юр╕┤р╣Ир╕б `.indexOn` р╕кр╕│р╕лр╕гр╕▒р╕Ъ BingoGame Cards (`userId`)
- [ ] р╣Ар╕Юр╕┤р╣Ир╕б `.indexOn` р╕кр╕│р╕лр╕гр╕▒р╕Ъ LiveChat (`timestamp`)
- [ ] р╣Ар╕Юр╕┤р╣Ир╕б `.indexOn` р╕кр╕│р╕лр╕гр╕▒р╕Ъ LoyKrathongGame Krathongs (`timestamp`)
- [ ] р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ syntax р╕Вр╕нр╕З JSON р╕зр╣Ир╕▓р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
- [ ] Publish rules р╣Гр╕Щ Firebase Console
- [ ] р╕гр╕н 1-5 р╕Щр╕▓р╕Чр╕╡ р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й Firebase р╕кр╕гр╣Йр╕▓р╕З indexes
- [ ] р╕Чр╕Фр╕кр╕нр╕Ъ Query р╕зр╣Ир╕▓р╕Чр╕│р╕Зр╕▓р╕Щр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З (р╕Фр╕╣ console р╕зр╣Ир╕▓р╕бр╕╡ warning р╕лр╕гр╕╖р╕нр╣Др╕бр╣И)

---

## ЁЯЪи Common Errors

### Error 1: JSON Syntax Error
```
Error: Unexpected token in JSON at position X
```
**р╣Бр╕Бр╣Йр╣Др╕В:** р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ JSON syntax р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З (р╣Др╕бр╣Ир╕бр╕╡ trailing comma, quote р╕Др╕гр╕Ъ)

### Error 2: Invalid Index Path
```
Error: Index path does not match query path
```
**р╣Бр╕Бр╣Йр╣Др╕В:** р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ `.indexOn` р╕нр╕вр╕╣р╣Ир╣Гр╕Щ path р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕Хр╕▓р╕б query

### Error 3: Index Not Working
```
Warning: Query requires index but index not found
```
**р╣Бр╕Бр╣Йр╣Др╕В:** 
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ rules р╣Др╕Фр╣Й publish р╣Бр╕ер╣Йр╕з
- р╕гр╕нр╕кр╕▒р╕Бр╕Др╕гр╕╣р╣И (1-5 р╕Щр╕▓р╕Чр╕╡) р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й Firebase р╕кр╕гр╣Йр╕▓р╕З indexes
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ path р╣Бр╕ер╕░ field name р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З

---

## ЁЯУЪ р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З Rules р╕Чр╕╡р╣Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М

р╕Фр╕╣р╣Др╕Яр╕ер╣М `DATABASE-RULES-WITH-INDEXES.json` р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З rules р╕Чр╕╡р╣Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М

---

**р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕:** р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Б publish rules р╣Бр╕ер╣Йр╕з р╕нр╕▓р╕Ир╕Хр╣Йр╕нр╕Зр╕гр╕н 1-5 р╕Щр╕▓р╕Чр╕╡ р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й Firebase р╕кр╕гр╣Йр╕▓р╕З indexes р╣Ар╕кр╕гр╣Зр╕Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М

