# Migration Guide: PATCH Refactor ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•

## ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ: **‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞:
1. ‚úÖ **PUT endpoint ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ** (backward compatible)
2. ‚úÖ **Merge logic ‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤**
3. ‚úÖ **Frontend ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ PUT ‡πÑ‡∏î‡πâ** (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)

---

## ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤

### 1. Base64 Images ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

**‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå**: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ base64 images ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ä‡πà‡∏ô `announce.imageDataUrl` ‡πÄ‡∏õ‡πá‡∏ô `data:image/jpeg;base64,...`)

**‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö**:
- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- ‡πÅ‡∏ï‡πà payload size ‡∏¢‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà (~900KB)
- ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏à‡∏≤‡∏Å PATCH optimization

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ**:
- **Option A (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)**: ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Å‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí ‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- **Option B**: ‡∏™‡∏£‡πâ‡∏≤‡∏á migration script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

### 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ Array ‡∏ß‡πà‡∏≤‡∏á

**‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå**: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà `announce.users = []` ‡πÅ‡∏•‡∏∞ `announce.userBonuses = []` ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

**‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö**:
- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- Merge logic ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ array ‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
- ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV ‡πÉ‡∏´‡∏°‡πà

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ**:
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ array ‡∏ß‡πà‡∏≤‡∏á
- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

---

## Migration Script (Optional)

‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á base64 images ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô URLs ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ:

```javascript
// backend/scripts/migrateBase64Images.js
import { getPool, getSchema } from '../src/config/database.js';
import { processImageFields } from '../src/utils/imageProcessor.js';

async function migrateBase64Images(theme = 'heng36') {
  const pool = getPool(theme);
  const schema = getSchema(theme);
  
  // Get all games with announce data
  const result = await pool.query(
    `SELECT game_id, game_data FROM ${schema}.games 
     WHERE game_data->>'announce' IS NOT NULL`
  );
  
  for (const row of result.rows) {
    const gameData = row.game_data;
    const announce = gameData.announce;
    
    // Check if imageDataUrl is base64
    if (announce?.imageDataUrl && announce.imageDataUrl.startsWith('data:image/')) {
      try {
        // Process image
        const processed = await processImageFields(
          { announce },
          theme,
          'announce'
        );
        
        // Update database
        const updatedGameData = {
          ...gameData,
          announce: processed.announce
        };
        
        await pool.query(
          `UPDATE ${schema}.games 
           SET game_data = $1, updated_at = CURRENT_TIMESTAMP
           WHERE game_id = $2`,
          [JSON.stringify(updatedGameData), row.game_id]
        );
        
        console.log(`‚úÖ Migrated: ${row.game_id}`);
      } catch (error) {
        console.error(`‚ùå Error migrating ${row.game_id}:`, error);
      }
    }
  }
}

// Run migration
migrateBase64Images('heng36')
  .then(() => console.log('Migration complete'))
  .catch(console.error);
```

---

## Checklist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Deploy

### Phase 1: Deploy Backend (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
- [x] Deploy backend code ‡πÉ‡∏´‡∏°‡πà
- [x] PUT endpoint ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- [x] PATCH endpoints ‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
- [x] ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ

### Phase 2: Frontend Migration (Optional - ‡∏ó‡∏≥‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ)
- [ ] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï frontend ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ PATCH ‡πÅ‡∏ó‡∏ô PUT
- [ ] ‡πÉ‡∏ä‡πâ `/games/:id/state` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö lightweight checks
- [ ] ‡πÉ‡∏ä‡πâ `/games/:id/snapshot` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö full data
- [ ] ‡πÉ‡∏ä‡πâ `PATCH /games/:id/announce` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö announce updates

### Phase 3: Data Migration (Optional - ‡∏ó‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°)
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ base64 images
- [ ] ‡∏£‡∏±‡∏ô migration script (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
- [ ] ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Å‡∏° ‚Üí ‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

---

## ‡∏™‡∏£‡∏∏‡∏õ

### ‚úÖ **‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**
- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
- Backend ‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
- ‡πÑ‡∏°‡πà‡∏°‡∏µ breaking changes

### üìù **‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏≥ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°)**
1. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ base64 images**: 
   ```sql
   SELECT game_id, name 
   FROM games 
   WHERE game_data->'announce'->>'imageDataUrl' LIKE 'data:image/%';
   ```

2. **‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ base64 images**: 
   - ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Å‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ CreateGame
   - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)

3. **‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏±‡∏ô migration script**: 
   - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏Å‡∏°‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

### üöÄ **‡πÄ‡∏°‡∏∑‡πà‡∏≠ Frontend ‡πÉ‡∏ä‡πâ PATCH**
- Payload size ‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á ~90%
- Latency ‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á ~88%
- Bandwidth ‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á ~95%

---

## ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢

**Q: ‡∏ï‡πâ‡∏≠‡∏á migrate ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÑ‡∏´‡∏°?**  
A: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ

**Q: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ base64 images ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô?**  
A: ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà payload ‡∏¢‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà ‡∏Ñ‡∏ß‡∏£‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô URL

**Q: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç frontend ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÑ‡∏´‡∏°?**  
A: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á PUT ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ migrate ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ PATCH

**Q: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÑ‡∏´‡∏°?**  
A: ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢ Merge logic ‡πÉ‡∏´‡∏°‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢

